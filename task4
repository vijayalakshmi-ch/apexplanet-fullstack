-- Assuming 'users' and 'roles' tables from Task 3 exist

-- 1. Create a Categories Table (Lookup table)
CREATE TABLE categories (
    id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE
);

INSERT INTO categories (name) VALUES ('Electronics'), ('Books'), ('Apparel');

-- 2. Create the Products CRUD Module Table
CREATE TABLE products (
    id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    category_id INT NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    created_by INT, -- To track which Admin created the product
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- Foreign Key 1: Link product to its category
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE RESTRICT,
    
    -- Foreign Key 2: Link product to the Admin user who created it (optional, but good for tracking)
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL 
);

-- Insert Dummy Data
INSERT INTO products (name, description, price, category_id, stock, created_by) VALUES
('Laptop Pro X', 'High-performance computing device.', 1200.00, 1, 50, 2), -- Assume user ID 2 is an Admin
('The Full Stack Guide', 'A comprehensive development book.', 45.99, 2, 200, 2);
<?php
// check_admin.php: Role-Based Access Control Check

// Must start the session to check user status
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// 1. Check if the user is logged in at all
if (!isset($_SESSION["loggedin"]) || $_SESSION["loggedin"] !== true) {
    // If not logged in, redirect to login page
    header("location: login.php");
    exit;
}

// 2. Check if the user has the 'Admin' role (assuming 2 is the Admin role_id from Task 3)
// Check if role_id is set and if it is NOT the admin role (e.g., role_id 2)
if (!isset($_SESSION["role_id"]) || $_SESSION["role_id"] != 2) {
    // If not an admin, redirect to a non-admin page or show an error
    $_SESSION['error_message'] = "Access Denied. You do not have administrator privileges.";
    header("location: index.php"); // Redirect to the public home page
    exit;
}

// If the script reaches here, the user is an authenticated Admin.
?>
<?php
// manage_products.php: Display Products in Admin Panel

// Include the security check first
require_once 'check_admin.php'; 
// Include the database connection
require_once 'config.php';

// Assuming you have HTML header/template includes
include 'admin_header.php'; 

echo "<div class='container-fluid mt-4'>";
echo "<h2><i class='fas fa-box'></i> Manage Products</h2>";
echo "<a href='add_product.php' class='btn btn-success mb-3'>+ Add New Product</a>";

// 1. Construct the JOIN Query
$sql = "SELECT 
            p.id, p.name, p.price, p.stock, c.name AS category_name 
        FROM products p
        JOIN categories c ON p.category_id = c.id
        ORDER BY p.id DESC";

if ($result = $conn->query($sql)) {
    if ($result->num_rows > 0) {
        echo "<div class='table-responsive'>";
        echo "<table class='table table-striped table-hover'>";
            echo "<thead class='table-dark'>";
                echo "<tr>";
                    echo "<th>ID</th>";
                    echo "<th>Product Name</th>";
                    echo "<th>Category</th>"; // Data from the joined table
                    echo "<th>Price</th>";
                    echo "<th>Stock</th>";
                    echo "<th>Actions</th>";
                echo "</tr>";
            echo "</thead>";
            echo "<tbody>";
            
            while ($row = $result->fetch_assoc()) {
                echo "<tr>";
                    echo "<td>" . $row['id'] . "</td>";
                    echo "<td>" . htmlspecialchars($row['name']) . "</td>";
                    echo "<td>" . htmlspecialchars($row['category_name']) . "</td>";
                    echo "<td>$" . number_format($row['price'], 2) . "</td>";
                    echo "<td>" . $row['stock'] . "</td>";
                    echo "<td>";
                        // Links for Update, Delete, and potentially View
                        echo "<a href='edit_product.php?id=" . $row['id'] . "' class='btn btn-info btn-sm me-2'>Edit</a>";
                        echo "<a href='delete_product.php?id=" . $row['id'] . "' class='btn btn-danger btn-sm' onclick='return confirm(\"Confirm delete: " . htmlspecialchars($row['name']) . "?\");'>Delete</a>";
                    echo "</td>";
                echo "</tr>";
            }
            echo "</tbody>";
        echo "</table>";
        echo "</div>"; // Close table-responsive
        
        $result->free();
    } else {
        echo "<div class='alert alert-info'>No products found.</div>";
    }
} else {
    echo "<div class='alert alert-danger'>ERROR: Could not execute query.</div>";
}

$conn->close();
include 'admin_footer.php'; // Assuming you have HTML footer/template includes
?>
